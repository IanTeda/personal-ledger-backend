#-- .Makefile.toml ---

# ==============================================================================
# Makefile.toml for cargo-make
#
# Cargo Make is a task runner for Rust projects that allows you to define custom tasks
# in a simple TOML format. It provides a way to automate common development workflows
# like building, testing and serving documentation.
#
# This file defines tasks for the personal-ledger-backend project.
#
# Usage: cargo make <task-name>
# Example: cargo make docs-serve
# -----------------------------------------------------------------------------


## Update git submodules in repository
## $ git submodule update --recursive --remote
## $ cargo make submodules
[tasks.submodules]
command = "git"
args = ["submodule", "update", "--recursive", "--remote"]



# -------------------------------[BINARY BUILDS]-------------------------------------

## Run cargo tests
## This task will run the project unit and integration tests
## `$ cargo make test`
[tasks.test]
description = "Run cargo tests"
command = "cargo"
args = ["test"]


# -------------------------------[MD BOOK]-------------------------------------

[tasks.docs-rustdoc]
description = "Build Rust docs (with RUSTDOCFLAGS to set asset root)"
env = { RUSTDOCFLAGS = "-Z unstable-options --static-root-path /rust-docs" }
command = "sh"
args = ["-c", "cargo +nightly doc --no-deps --target-dir docs/rustdoc"]

[tasks.docs-mdbook]
description = "Build mdBook documentation"
command = "sh"
args = ["-c", "mdbook build"]

[tasks.docs-build]
description = "Build all documentation"
dependencies = ["docs-rustdoc", "docs-mdbook"]

[tasks.docs-serve]
install_crate = "mdbook"
description = "Serve mdBook documentation on port 8001"
command = "mdbook"
args = ["serve", "--port", "8001"]



# -------------------------------[DATABASE]------------------------------------

## Drop Database
## $ sqlx database drop
## $ cargo make db_drop
[tasks.db-drop]
install_crate = "sqlx-cli"
command = "sqlx"
args = ["database", "drop", "-y"]

## Create Database
## $ sqlx database create
[tasks.db-create]
install_crate = "sqlx-cli"
command = "sqlx"
args = ["database", "create"]

## Migrate database
## $ sqlx migrate run
[tasks.db-migrate]
install_crate = "sqlx-cli"
command = "sqlx"
args = ["migrate", "run"]

[tasks.db-prepare]
install_crate = "sqlx-cli"
command = "cargo"
args = ["sqlx", "prepare", "--check"]

[tasks.db-prepare-generate]
install_crate = "sqlx-cli"
command = "cargo"
args = ["sqlx", "prepare"]

# Run Database tasks. You need to exit vscode before running as vscode has an open connection to the database.
# $ cargo make db
[tasks.db]
dependencies = [
    "db-drop",
    "db-create",
    "db-migrate",
    "db-prepare-generate",
    "db-prepare",
]

# -------------------------------[DOCKER]------------------------------------
## Build Docker image
## $ docker build -t personal-ledger-backend .
## $ cargo make docker-build
[tasks.docker-build]
description = "Build Docker image from Dockerfile"
dependencies = ["test", "build"]
command = "docker"
args = ["build", "-t", "personal-ledger-backend", "."]

## Test Docker image
## $ docker run --rm personal-ledger-backend ./personal_ledger_backend --help
## $ cargo make docker-test
[tasks.docker-test]
description = "Test the Docker image by running the binary with --help"
dependencies = ["docker-build"]
command = "docker"
args = ["run", "--rm", "personal-ledger-backend", "./personal_ledger_backend", "--help"]


# -------------------------------[CROSS-COMPILATION]----------------------------------
## Build for Linux ARM64
## $ rustup target add aarch64-unknown-linux-gnu
## $ cargo make build-linux-arm64
[tasks.build-linux-arm64]
description = "Build binary for Linux ARM64 architecture"
command = "cargo"
args = ["build", "--release", "--target", "aarch64-unknown-linux-gnu", "--bin", "personal_ledger_backend"]

## Build for Linux x86_64
## $ rustup target add x86_64-unknown-linux-gnu
## $ cargo make build-linux-x64
[tasks.build-linux-x64]
description = "Build binary for Linux x86_64 architecture"
command = "cargo"
args = ["build", "--release", "--target", "x86_64-unknown-linux-gnu", "--bin", "personal_ledger_backend"]

## Build for macOS ARM64 (Apple Silicon)
## $ rustup target add aarch64-apple-darwin
## $ cargo make build-macos-arm64
[tasks.build-macos-arm64]
description = "Build binary for macOS ARM64 (Apple Silicon) architecture"
command = "cargo"
args = ["build", "--release", "--target", "aarch64-apple-darwin", "--bin", "personal_ledger_backend"]

## Build for macOS x86_64 (Apple Intel)
## $ rustup target add x86_64-apple-darwin
## $ cargo make build-macos-x64
[tasks.build-macos-x64]
description = "Build binary for macOS x86_64 (Apple Intel) architecture"
command = "cargo"
args = ["build", "--release", "--target", "x86_64-apple-darwin", "--bin", "personal_ledger_backend"]

## Build for Windows x64
## $ rustup target add x86_64-pc-windows-msvc
## $ cargo make build-windows-x64
[tasks.build-windows-x64]
description = "Build binary for Windows x64 architecture"
command = "cargo"
args = ["build", "--release", "--target", "x86_64-pc-windows-msvc", "--bin", "personal_ledger_backend"]

## Build for RISC-V 64-bit Linux
## $ rustup target add riscv64gc-unknown-linux-gnu
## $ cargo make build-riscv64
[tasks.build-riscv64]
description = "Build binary for RISC-V 64-bit Linux architecture"
command = "cargo"
args = ["build", "--release", "--target", "riscv64gc-unknown-linux-gnu", "--bin", "personal_ledger_backend"]
